<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartCard Tester Control</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh; background: #f0f0f0;
    }
    .container {
      background: white;
      padding: 28px 32px 24px 32px;
      margin-top: 40px;
      border-radius: 14px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.12);
      width: 96vw;
      max-width: 900px;
      min-width: 340px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    h1 { text-align: center; font-size: 1.7rem; margin-bottom: 0.7em; }

    form {
      display: flex;
      flex-direction: column;
      gap: 0;
      width: 100%;
    }
    .fields-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 18px 30px;
      margin-bottom: 0;
      align-items: flex-end;
      justify-content: flex-start;
    }
    .field-group {
      display: flex;
      flex-direction: column;
      min-width: 120px;
      flex: 1 1 150px;
      max-width: 230px;
    }
    .field-group label {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .field-group input,
    .field-group select {
      font-size: 1.07rem;
      padding: 7px 10px;
      border: 1.2px solid #bbb;
      border-radius: 5px;
      background: #f8f8fa;
      margin-bottom: 0;
    }
    .horizontal-fields {
      display: flex;
      gap: 24px;
      align-items: flex-end;
      margin-top: 6px;
      margin-bottom: 0;
      flex-wrap: wrap;
    }
    .flex-grow { flex: 2 1 220px; }

    .run-mode-row {
      display: flex;
      gap: 24px;
      align-items: center;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .radio-group {
      display: flex;
      gap: 18px;
      align-items: center;
      background: #f8f8fa;
      border-radius: 5px;
      padding: 7px 16px;
    }
    .radio-group label {
      font-weight: 500;
      font-size: 1.02rem;
      gap: 4px;
      cursor: pointer;
    }
    .radio-group input[type="radio"] {
      accent-color: #0066cc;
      margin-right: 5px;
    }
    .swipe-group {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .swipe-group .field-group {
      margin-bottom: 0;
      min-width: 110px;
    }
    .btn-row {
      display: flex;
      gap: 16px;
      margin-top: 18px;
      align-items: center;
      justify-content: flex-start;
    }
    button {
      font-size: 1rem; font-weight: 600;
      padding: 11px 28px;
      background: #0066cc;
      color: white;
      border: none; border-radius: 5px;
      cursor: pointer;
      margin-top: 0;
      transition: background 0.18s;
    }
    button:hover { background: #005bb5; }
    #stopButton { background: #cc0000; }
    #stopButton:hover { background: #b50000; }

    #estimate {
      color: #666;
      font-size: 1.06rem;
      font-style: italic;
      margin-top: 13px;
      margin-bottom: 0;
      min-height: 1.6em;
      padding-left: 2px;
      text-align: left;
    }
    .status, .countdown, #progress {
      margin-top: 10px; font-size: 1.08rem; text-align: left;
    }
    .status { font-weight: bold; }
    .tick { color: #20a020; font-weight: bold; }
    .err { color: #c00; font-weight: bold; }
    #progress { font-weight: bold; color: #444;}

    @media (max-width: 900px) {
      .container { max-width: 99vw; }
      .fields-grid, .horizontal-fields, .run-mode-row, .btn-row, .swipe-group {
        flex-direction: column; gap: 8px;
      }
      .field-group { max-width: 100vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SmartCard Tester Control</h1>
    <form id="controlForm" autocomplete="off">
      <div class="fields-grid">
        <div class="field-group">
          <label for="vncHost">Printer IP:</label>
          <input type="text" id="vncHost" placeholder="10.15.57.7">
        </div>
        <div class="field-group">
          <label for="vncDisplay">Display #:</label>
          <input type="number" id="vncDisplay" value="8" min="0">
        </div>
        <div class="field-group">
          <label for="vncPassword">VNC Password:</label>
          <input type="password" id="vncPassword" autocomplete="new-password">
        </div>
        <div class="field-group">
          <label for="pinValue">Card PIN:</label>
          <input type="text" id="pinValue" placeholder="123456">
        </div>
        <div class="field-group">
          <label for="waitBefore">Delay before PIN (s):</label>
          <input type="number" id="waitBefore" value="2" min="0">
        </div>
        <div class="field-group">
          <label for="waitAfter">Delay before eject (s):</label>
          <input type="number" id="waitAfter" value="10" min="0">
        </div>
        <div class="field-group">
          <label for="speedSelect">Sweep Speed (ms/°):</label>
          <select id="speedSelect">
            <option value="15">Fast</option>
            <option value="50">Medium</option>
            <option value="200">Slow</option>
          </select>
        </div>
        <div class="field-group">
          <label for="pauseDelay">Delay between swipes (s):</label>
          <input type="number" id="pauseDelay" value="1" min="0" step="0.1">
        </div>
      </div>

      <div class="run-mode-row">
        <div class="radio-group">
          <label><input type="radio" name="mode" value="fixed" checked> Fixed</label>
          <label><input type="radio" name="mode" value="infinite"> Infinite</label>
        </div>
        <div class="swipe-group" id="fixedSection" style="margin-left:24px;">
          <div class="field-group" style="margin-bottom:0;">
            <label for="numSwipes">Number of swipes:</label>
            <input type="number" id="numSwipes" value="5" min="1">
          </div>
        </div>
      </div>

      <div id="estimate"></div>
      <div class="btn-row">
        <button type="submit" id="startButton">Start</button>
        <button type="button" id="stopButton" style="display:none;">Stop</button>
      </div>
    </form>
    <div class="status" id="status">Status: idle</div>
    <div class="countdown" id="swipeCountdown"></div>
    <div class="countdown" id="pinCountdown"></div>
    <div class="countdown" id="ejectCountdown"></div>
    <div id="progress"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  // --- JS is 100% same as before ---
  (function(){
    const socket       = io();
    const vncHostIn    = document.getElementById('vncHost');
    const vncDispIn    = document.getElementById('vncDisplay');
    const vncPassIn    = document.getElementById('vncPassword');
    const pinInput     = document.getElementById('pinValue');
    const waitBefore   = document.getElementById('waitBefore');
    const waitAfter    = document.getElementById('waitAfter');
    const modeRadios   = document.querySelectorAll("input[name='mode']");
    const fixedSection = document.getElementById('fixedSection');
    const numSwipesIn  = document.getElementById('numSwipes');
    const speedSelect  = document.getElementById('speedSelect');
    const pauseInput   = document.getElementById('pauseDelay');
    const form         = document.getElementById('controlForm');
    const startBtn     = document.getElementById('startButton');
    const stopBtn      = document.getElementById('stopButton');
    const statusDiv    = document.getElementById('status');
    const swipeDiv     = document.getElementById('swipeCountdown');
    const pinDiv       = document.getElementById('pinCountdown');
    const ejectDiv     = document.getElementById('ejectCountdown');
    const estimateDiv  = document.getElementById('estimate');
    const progressDiv  = document.getElementById('progress');
    let swipeTimer, pinTimer, ejectTimer, swipeCountdownTimer, pinCountdownTimer, fixedSwipeCount, totalSwipes, sessionMode;

    function updateMode(){
      const m = document.querySelector("input[name='mode']:checked").value;
      fixedSection.style.display = m==='fixed'?'flex':'none';
      numSwipesIn.disabled       = m!=='fixed';
      estimateDiv.style.display  = m==='fixed'?'block':'none';
      progressDiv.style.display  = m==='fixed'?'block':'none';
      if (m === 'fixed') showEstimate();
      else estimateDiv.textContent = '';
    }

    function showEstimate() {
      const nSwipes = parseInt(numSwipesIn.value) || 1;
      const pauseS = parseFloat(pauseInput.value) || 0;
      const waitPin = parseFloat(waitBefore.value) || 0;
      const waitEject = parseFloat(waitAfter.value) || 0;
      const step = parseInt(speedSelect.value) || 15;
      const cardMoveTime = ((95-20)*2)*step/1000; // seconds for both in & out
      const cycleTime = pauseS + cardMoveTime + waitPin + waitEject;
      const totalTime = nSwipes * cycleTime;
      estimateDiv.textContent = `Estimated total time: ~${Math.round(totalTime)} seconds (${(totalTime/60).toFixed(1)} min)`;
    }
    [numSwipesIn, pauseInput, waitBefore, waitAfter, speedSelect].forEach(inp=>{
      inp.addEventListener('input', showEstimate);
    });

    modeRadios.forEach(r=>r.addEventListener('change',updateMode));
    updateMode();

    function resetUI(){
      clearTimeout(swipeTimer); clearTimeout(pinTimer); clearTimeout(ejectTimer);
      clearInterval(swipeCountdownTimer); clearInterval(pinCountdownTimer);
      swipeDiv.textContent = '';
      pinDiv.textContent   = '';
      ejectDiv.textContent = '';
      progressDiv.textContent = '';
      startBtn.style.display = 'block';
      stopBtn.style.display  = 'none';
      fixedSwipeCount = 0;
      totalSwipes = 0;
    }

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      // gather inputs
      const host = vncHostIn.value.trim();
      const disp = parseInt(vncDispIn.value) || 0;
      const pass = vncPassIn.value;
      const pin  = pinInput.value.trim();
      const wb   = parseFloat(waitBefore.value);
      const wa   = parseFloat(waitAfter.value);
      const nSw  = parseInt(numSwipesIn.value) || 1;
      const step = parseInt(speedSelect.value)  || 15;
      const pau  = parseFloat(pauseInput.value)    || 0; // now in seconds
      if(!host || !pin){
        statusDiv.textContent = 'Status: IP & PIN required';
        return;
      }
      const mode = document.querySelector("input[name='mode']:checked").value;
      sessionMode = mode;
      fixedSwipeCount = 0;
      totalSwipes = nSw;
      const qs   =
        `mode=${mode}` +
        `&numSwipes=${nSw}` +
        `&stepDelay=${step}&pauseDelay=${pau*1000}` + // convert to ms for server
        `&vncHost=${encodeURIComponent(host)}` +
        `&vncDisplay=${disp}` +
        `&vncPass=${encodeURIComponent(pass)}` +
        `&waitBefore=${wb}&waitAfter=${wa}&pin=${encodeURIComponent(pin)}`;
      statusDiv.textContent = 'Status: Connecting to VNC…';
      resetUI();
      try {
        await fetch(`/run?${qs}`);
      } catch(err) {
        statusDiv.textContent = 'Status: Failed to configure';
        console.error(err);
      }
    });

    stopBtn.addEventListener('click', async ()=>{
      await fetch('/stop');
      statusDiv.textContent = 'Status: stopped';
      resetUI();
    });

    function startCountdown(div, secs, label, onDone) {
      div.textContent = `${label} in ${secs}s`;
      let remain = secs;
      let timer = setInterval(() => {
        remain--;
        if (remain <= 0) {
          clearInterval(timer);
          div.textContent = '';
          onDone && onDone();
        } else {
          div.textContent = `${label} in ${remain}s`;
        }
      }, 1000);
      return timer;
    }

    socket.on('status', msg => {
      if (msg === 'VNC connected') {
        statusDiv.innerHTML = '<span class="tick">✅ VNC connected</span>';
        resetUI();
        startBtn.style.display = 'none';
        stopBtn.style.display  = 'inline-block';
        if (sessionMode === 'fixed') {
          fixedSwipeCount = 0;
          totalSwipes = parseInt(numSwipesIn.value) || 1;
          doSwipeCycle();
        } else if (sessionMode === 'infinite') {
          const pau = parseFloat(pauseInput.value) || 0;
          let remSwipe = Math.ceil(pau);
          swipeTimer = startCountdown(swipeDiv, remSwipe, "Next insert", async () => {
            statusDiv.textContent = 'Status: Card inserting';
            await fetch('/insert', { method: 'POST' });
          });
        }
      }
      else if (msg === 'VNC error') {
        statusDiv.innerHTML = '<span class="err">❌ VNC error</span>';
        resetUI();
      }
      else if (msg === 'Card removed') {
        statusDiv.textContent = 'Status: Card removed';
        if (sessionMode === 'infinite') {
          const pau = parseFloat(pauseInput.value) || 0;
          let remSwipe = Math.ceil(pau);
          swipeTimer = startCountdown(swipeDiv, remSwipe, "Next insert", async () => {
            statusDiv.textContent = 'Status: Card inserting';
            await fetch('/insert', { method: 'POST' });
          });
        }
      }
    });

    function doSwipeCycle() {
      if (fixedSwipeCount >= totalSwipes) {
        statusDiv.innerHTML = '<span class="tick">✅ Done! All swipes complete.</span>';
        progressDiv.textContent = '';
        startBtn.style.display = 'block';
        stopBtn.style.display  = 'none';
        return;
      }
      fixedSwipeCount++;
      progressDiv.textContent = `Swipe ${fixedSwipeCount} of ${totalSwipes}`;
      const pau = parseFloat(pauseInput.value) || 0;
      let remSwipe = Math.ceil(pau);
      swipeCountdownTimer = startCountdown(swipeDiv, remSwipe, "Next insert", async () => {
        statusDiv.textContent = 'Status: Card inserting';
        await fetch('/insert', { method: 'POST' });
      });
    }

    socket.on('card-inserted', () => {
      statusDiv.textContent = 'Status: Card inserted';
      const wb = parseFloat(waitBefore.value);
      let remPin = Math.ceil(wb);
      clearInterval(pinCountdownTimer);
      pinCountdownTimer = startCountdown(pinDiv, remPin, "Typing PIN", async () => {
        statusDiv.textContent = 'Status: Typing PIN';
        const pin = pinInput.value.trim();
        for (const ch of pin) {
          await fetch('/keypress', {
            method: 'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ key: ch })
          });
          await new Promise(r=>setTimeout(r,100));
        }
        await fetch('/keypress', {
          method: 'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ key:'enter' })
        });

        const wa = parseFloat(waitAfter.value);
        let remE = Math.ceil(wa);
        ejectTimer = startCountdown(ejectDiv, remE, "Ejecting card", async () => {
          statusDiv.textContent = 'Status: Ejecting card';
          await fetch('/insert', { method: 'POST' });
        });
      });
    });

    socket.on('card-removed', () => {
      statusDiv.textContent = 'Status: Card removed';
      if (sessionMode === 'fixed') {
        setTimeout(doSwipeCycle, 300);
      }
    });

  })();
  </script>
</body>
</html>

